.PHONY: deps seed run test docs docs-serve lint lint-fix clean all fresh debug compile unit-test

# ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
DBT_PROFILES_DIR := .
DBT_PROJECT_DIR := .

# Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ dbt
deps:
	@echo "ğŸ“¦ Installing dbt dependencies..."
	dbt deps --profiles-dir $(DBT_PROFILES_DIR)

seed:
	@echo "ğŸŒ± Loading seeds..."
	dbt seed --profiles-dir $(DBT_PROFILES_DIR)

run:
	@echo "ğŸš€ Running dbt models..."
	dbt run --profiles-dir $(DBT_PROFILES_DIR)

test:
	@echo "ğŸ§ª Running dbt tests..."
	dbt test --profiles-dir $(DBT_PROFILES_DIR)

unit-test:
	@echo "ğŸ”¬ Running unit tests..."
	dbt test --profiles-dir $(DBT_PROFILES_DIR) --select "test_type:unit"

compile:
	@echo "ğŸ“ Compiling dbt models..."
	dbt compile --profiles-dir $(DBT_PROFILES_DIR)

debug:
	@echo "ğŸ” Running dbt debug..."
	dbt debug --profiles-dir $(DBT_PROFILES_DIR)

# Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ
docs:
	@echo "ğŸ“š Generating documentation..."
	dbt docs generate --profiles-dir $(DBT_PROFILES_DIR)

docs-serve: docs
	@echo "ğŸŒ Serving documentation..."
	dbt docs serve --profiles-dir $(DBT_PROFILES_DIR)

# SQLFluff Ğ»Ğ¸Ğ½Ñ‚Ğ¸Ğ½Ğ³
lint:
	@echo "ğŸ” Linting SQL files..."
	sqlfluff lint models/ macros/ tests/

lint-fix:
	@echo "ğŸ”§ Fixing SQL files..."
	sqlfluff fix models/ macros/ tests/ --force

# Pre-commit
pre-commit-install:
	@echo "ğŸª Installing pre-commit hooks..."
	pre-commit install

pre-commit-run:
	@echo "â–¶ï¸ Running pre-commit on all files..."
	pre-commit run --all-files

# ĞÑ‡Ğ¸ÑÑ‚ĞºĞ°
clean:
	@echo "ğŸ§¹ Cleaning dbt artifacts..."
	dbt clean --profiles-dir $(DBT_PROFILES_DIR)
	rm -rf logs/
	rm -rf target/

# ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ»
all: deps seed run test
	@echo "âœ… Full dbt pipeline completed!"

# Ğ¡Ğ²ĞµĞ¶Ğ¸Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº (Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° + Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ»)
fresh: clean all
	@echo "ğŸ‰ Fresh build completed!"

# Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹
run-staging:
	@echo "ğŸš€ Running staging models..."
	dbt run --profiles-dir $(DBT_PROFILES_DIR) --select staging

run-marts:
	@echo "ğŸš€ Running mart models..."
	dbt run --profiles-dir $(DBT_PROFILES_DIR) --select marts

# Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… ÑĞ»Ğ¾Ñ‘Ğ²
test-staging:
	@echo "ğŸ§ª Testing staging models..."
	dbt test --profiles-dir $(DBT_PROFILES_DIR) --select staging

test-marts:
	@echo "ğŸ§ª Testing mart models..."
	dbt test --profiles-dir $(DBT_PROFILES_DIR) --select marts

# Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ°
help:
	@echo "Available commands:"
	@echo "  make deps          - Install dbt dependencies"
	@echo "  make seed          - Load seed files"
	@echo "  make run           - Run all models"
	@echo "  make test          - Run all tests"
	@echo "  make unit-test     - Run unit tests only"
	@echo "  make compile       - Compile models"
	@echo "  make debug         - Debug connection"
	@echo "  make docs          - Generate documentation"
	@echo "  make docs-serve    - Generate and serve documentation"
	@echo "  make lint          - Lint SQL files"
	@echo "  make lint-fix      - Fix SQL files"
	@echo "  make clean         - Clean artifacts"
	@echo "  make all           - Run full pipeline"
	@echo "  make fresh         - Clean and run full pipeline"
	@echo "  make run-staging   - Run staging models only"
	@echo "  make run-marts     - Run mart models only"
	@echo "  make test-staging  - Test staging models only"
	@echo "  make test-marts    - Test mart models only"
	@echo "  make help          - Show this help"
